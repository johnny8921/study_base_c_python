### 3. МК на базе Cortex-M. Структура проекта. Организация работы с памятью

#### Теория

- Обзор платформы Cortex. Организация доступа к памяти и перефирии. Обзор общих модулей. Стек.
- Обзор семейств контроллеров STM32. Основы выбора контроллера под задачу.
- Обзор специализированных инструментов STM32, CubeMX. Как не потерять наработки после перегенерации проекта
- HAL, LL

#### Практика

- Написание первых программ на STM32.

### Обзор платформы Cortex-M. 
#### Архитектура

Cortex-M4 — это 32-битное ядро, разработанное компанией ARM. Оно является частью серии Cortex-M и предназначено для
высокопроизводительных встраиваемых систем. Cortex-M4 сочетает в себе низкое энергопотребление с высокой
производительностью, что делает его идеальным выбором для широкого спектра приложений.

#### Основные характеристики

1. **Производительность**:
    - **Встроенный FPU (Floating Point Unit)**: Поддержка операций с плавающей точкой, что улучшает производительность в
      вычислениях.
    - **DSP инструкции**: Встроенные инструкции для цифровой обработки сигналов (DSP), что позволяет эффективно
      выполнять сложные вычисления.

2. **Периферийные устройства**:
    - **DMA (Direct Memory Access)**: Ускорение передачи данных между периферийными устройствами и памятью без участия
      процессора.
    - **Широкий спектр интерфейсов**: Поддержка SPI, I2C, UART, CAN, FlexRay, USB, Ethernet и других стандартных
      интерфейсов.
    - **Аналого-цифровые преобразователи (ADC)**: Высокоточные ADC для измерения аналоговых сигналов.
    - **Цифро-аналоговые преобразователи (DAC)**: Для генерации аналоговых сигналов.
    - **ШИМ (PWM)**: Широтно-импульсная модуляция для управления силовыми элементами.

#### Программирование и инструменты разработки

Для программирования микроконтроллеров с ядром Cortex-M4 доступны различные инструменты и среды разработки:

- **Keil MDK-ARM**: Популярная среда разработки с поддержкой отладки и прошивки.
- **IAR Embedded Workbench**: Среда разработки с мощными инструментами анализа и оптимизации кода.
- **STMicroelectronics STM32CubeIDE**: Бесплатная интегрированная среда разработки с поддержкой STM32CubeMX для
  конфигурации периферийных устройств.
- **GCC/GNU ARM Toolchain**: Бесплатный набор инструментов для компиляции и отладки.

#### Примеры использования

Cortex-M4 широко применяется в следующих областях:

- **Промышленная автоматизация**: Управление оборудованием, датчиками и исполнительными механизмами.
- **Автомобильные системы**: Бортовые компьютеры, системы безопасности, интеллектуальные системы управления.
- **Потребительская электроника**: Умные часы, беспроводные устройства, домашняя автоматизация.
- **IoT-устройства**: Устройства с подключением к интернету вещей, датчики, контроллеры.

### Организация доступа к памяти и перефирии Memory-Mapped I/O (MMIO)

#### Принцип работы
В MMIO периферийные устройства отображаются в адресное пространство памяти процессора. Это означает, что доступ к регистрам периферийных устройств осуществляется так же, как и доступ к обычной памяти. Вместо специальных команд ввода-вывода используются стандартные команды чтения и записи из памяти.

#### Преимущества
1. **Единообразие**: Использование стандартных команд чтения и записи упрощает программирование.
2. **Гибкость**: Возможность использования всех возможностей языка программирования для работы с периферией.
3. **Производительность**: Быстрый доступ к периферийным устройствам без необходимости дополнительных уровней абстракции.

### Структура адресного пространства

#### Адресное пространство
Адресное пространство микроконтроллера делится на несколько областей:
- **Оперативная память (RAM)**: Область для хранения данных и кода.
- **Флеш-память (Flash)**: Область для хранения постоянных данных и кода.
- **Область периферийных устройств**: Область, где расположены регистры периферийных устройств.

Пример структуры адресного пространства для STM32:

```
0x0000 0000 - 0x0007 FFFF: Флеш-память
0x2000 0000 - 0x2001 FFFF: Оперативная память
0x4000 0000 - 0x5FFFFFFF: Область периферийных устройств
```

### Пример работы с периферией через память

#### Пример с GPIO (General-Purpose Input/Output)
Рассмотрим пример работы с портом GPIO через MMIO.

1. **Определение адресов регистров**:
   - `GPIOA_BASE` = 0x4002_0000 (адрес базового регистра порта A)
   - `GPIOA_ODR` = 0x4002_0014 (адрес регистра вывода порта A)



### Обзор семейств контроллеров STM32. Основы выбора контроллера под задачу.
1. **STM32F4**
   - **Описание**: Это одно из самых популярных семейств STM32 с ядром Cortex-M4. Микроконтроллеры STM32F4 сочетают в себе высокую производительность, низкое энергопотребление и широкий спектр периферийных устройств.
   - **Основные характеристики**:
     - Ядро Cortex-M4 с FPU (Floating Point Unit).
     - Частота до 180 МГц.
     - Объем памяти: от 192 КБ до 1 МБ Flash, от 64 КБ до 512 КБ RAM.
     - Поддержка DSP инструкций.
     - Широкий набор периферийных устройств, включая DMA, USB, Ethernet, CAN, SPI, I2C, UART, ADC, DAC, PWM и другие.
   - **Применение**: Промышленная автоматизация, автомобильные системы, IoT-устройства, медицинские устройства.

2. **STM32H7**
   - **Описание**: STM32H7 — это более мощное семейство микроконтроллеров с двумя ядрами: Cortex-M7 и Cortex-M4. Это позволяет использовать преимущества обоих ядер для выполнения сложных задач.
   - **Основные характеристики**:
     - Ядро Cortex-M7 (до 480 МГц) и ядро Cortex-M4 (до 240 МГц).
     - Объем памяти: до 2 МБ Flash, до 1 МБ RAM.
     - Поддержка FPU и DSP инструкций.
     - Расширенный набор периферийных устройств, включая USB, Ethernet, CAN, SPI, I2C, UART, ADC, DAC, PWM и другие.
   - **Применение**: Высокопроизводительные встраиваемые системы, промышленные контроллеры, автомобильные системы, IoT-устройства.

3. **STM32G4**
   - **Описание**: STM32G4 — это семейство микроконтроллеров с улучшенной производительностью и энергоэффективностью. Они предназначены для средних и высоких уровней производительности.
   - **Основные характеристики**:
     - Ядро Cortex-M4 с FPU.
     - Частота до 170 МГц.
     - Объем памяти: от 128 КБ до 512 КБ Flash, от 32 КБ до 128 КБ RAM.
     - Поддержка DSP инструкций.
     - Широкий набор периферийных устройств, включая DMA, USB, CAN, SPI, I2C, UART, ADC, DAC, PWM и другие.
   - **Применение**: Промышленная автоматизация, автомобильные системы, потребительская электроника, IoT-устройства.

4. **STM32L4**
   - **Описание**: STM32L4 — это семейство микроконтроллеров с низким энергопотреблением и высокой производительностью. Они идеально подходят для устройств, работающих на батареях.
   - **Основные характеристики**:
     - Ядро Cortex-M4 с FPU.
     - Частота до 120 МГц.
     - Объем памяти: от 128 КБ до 1 МБ Flash, от 32 КБ до 320 КБ RAM.
     - Поддержка DSP инструкций.
     - Широкий набор периферийных устройств, включая DMA, USB, CAN, SPI, I2C, UART, ADC, DAC, PWM и другие.
   - **Применение**: Устройства с питанием от батарей, IoT-устройства, портативные устройства.

### Обзор специализированных инструментов STM32, CubeMX. Как не потерять наработки после перегенерации проекта
Ведь все знают ардуину? В чем ее главный плюс? Низкий порог входа!
Разработчики компании ST позаботились о том что бы их контроллеры тоже не требовали шаманских приседаний.
Они придумали несколько инструментов, которые координально помогают пользователю программировать их устройства.

 STM32CubeMX — это мощный инструмент, разработанный компанией STMicroelectronics для конфигурации и генерации кода для микроконтроллеров семейства STM32. Он значительно упрощает процесс разработки, позволяя быстро настроить периферийные устройства и сгенерировать начальный код для проекта.

### Основные функции STM32CubeMX

1. **Графический интерфейс пользователя (GUI)**
   - **Легкость использования**: CubeMX предоставляет интуитивно понятный графический интерфейс, который позволяет легко настраивать параметры микроконтроллера.
   - **Визуальная конфигурация**: Пользователи могут визуально выбирать и настраивать периферийные устройства, такие как GPIO, таймеры, UART, SPI, I2C, ADC, DAC, PWM и другие.

2. **Конфигурация периферийных устройств**
   - **GPIO**: Настройка портов ввода-вывода, включая режимы работы, скорости передачи и уровни напряжения.
   - **Таймеры**: Конфигурация таймеров, включая режимы работы, прерывания и периоды.
   - **Синхронные интерфейсы**: Настройка SPI, I2C, CAN и других синхронных интерфейсов.
   - **Асинхронные интерфейсы**: Настройка UART, USB, Ethernet и других асинхронных интерфейсов.
   - **Аналого-цифровые преобразователи (ADC)**: Настройка каналов и режимов работы.
   - **Цифро-аналоговые преобразователи (DAC)**: Настройка каналов и режимов работы.
   - **ШИМ (PWM)**: Настройка каналов и параметров модуляции.

3. **Генерация кода**
   - **Автоматическая генерация кода**: После настройки периферийных устройств CubeMX автоматически генерирует исходный код, который можно использовать в среде разработки.
   - **Поддержка различных IDE**: Генерированный код может быть использован в различных средах разработки, таких как Keil MDK-ARM, IAR Embedded Workbench, STM32CubeIDE и GCC/GNU ARM Toolchain.
   - **Настройка проекта**: CubeMX также помогает настроить проект, включая выбор библиотек, оптимизацию кода и настройку компилятора.

4. **Управление энергопотреблением**
   - **Режимы работы**: Настройка различных режимов работы микроконтроллера, включая рабочий режим, спящий режим и глубокий спящий режим.
   - **Оптимизация энергопотребления**: CubeMX помогает оптимизировать энергопотребление путем настройки различных параметров микроконтроллера.

5. **Документация и поддержка**
   - **Подробная документация**: CubeMX предоставляет доступ к подробной документации по каждому периферийному устройству и его настройкам.
   - **Примеры и шаблоны**: Включены примеры и шаблоны проектов, которые помогают быстро начать работу.

После использования CubeMX у программиста был проект который можно было собрать установив еще нужный компилятор.
Далее был стандартный метод разработки в IAR или KEIL. По моему мнению эти интсрументы были написаны злыми людьми для того что бы разработчик для МК страдал еще больше.
Программисты на всех конфестах плакали и делились своей болью между собой и производителями контроллеров.
В итоге ST выпустили продукт который называется CubeIDE. 

### Основные функции STM32CubeIDE

1. **Интеграция с STM32CubeMX**
   - **Генерация кода**: CubeIDE тесно интегрируется с STM32CubeMX, что позволяет легко генерировать начальный код для проекта.
   - **Автоматическая конфигурация**: После настройки периферийных устройств в STM32CubeMX, можно быстро импортировать проект в CubeIDE.

2. **Редактор кода**
   - **Синтаксис-ориентированный редактор**: Поддержка синтаксического выделения, автодополнения кода и навигации по файлам.
   - **Управление версиями**: Интеграция с системами контроля версий, такими как Git.

3. **Отладка**
   - **Поддержка отладчиков**: Встроенные средства отладки, совместимые с JTAG/SWD отладчиками.
   - **Точки останова**: Возможность установки точек останова, просмотра значений переменных и выполнения шаг за шагом.
   - **Консоли отладки**: Инструменты для мониторинга и анализа данных во время выполнения программы.

4. **Прошивка**
   - **Программирование микроконтроллеров**: Встроенная поддержка программирования через JTAG/SWD интерфейсы.
   - **Массовое программирование**: Возможность массового программирования нескольких устройств одновременно.

5. **Анализ производительности**
   - **Профилирование**: Инструменты для анализа производительности и оптимизации кода.
   - **Трассировка**: Возможность трассировки выполнения программы для анализа поведения приложения.

6. **Управление проектами**
   - **Многоязычная поддержка**: Поддержка C, C++, и других языков программирования.
   - **Многопроектное окружение**: Возможность работы с несколькими проектами одновременно.
   - **Настройка компилятора**: Гибкие настройки компилятора и линкера.

7. **Документация и примеры**
   - **Библиотеки и примеры**: Доступ к библиотекам STM32 HAL (Hardware Abstraction Layer) и примерам проектов.
   - **Помощь и документация**: Встроенная документация и справочная система для быстрого доступа к информации.

В итоге получился продукт, который если и не был простым, то имел набор документации для работы с ним, имел встроенный генератор кода на основе графического интерфейса.
Все это сделало жизнь разраба чуть легче и проще.

### HAL, LL
Как мы помним, наши контроллеры являются Memory Mapped контрорллерами. Т.е. доступ к перефирии является просто адресом в памяти.
Однако запоминать все адреса, а уж тем более писать установку битов в каждом регистре в ручную - дело неблагодарное
Поэтому появляется первая прослойка над контроллерами CMSIS (Cortex Microcontroller Software Interface Standard). Здесь мы получаем набор функций для работы с регистрами не указывая их адреса, а используя удобные человекочитаемые обозначения
Следующим шагом появляется HAL - Human Abstract Layer. Эта библиотека еще больше инкапсулировала работу с регистрами и упростила работу программиста. В HAL добавлены все необходимые методы и функции для инициализации контроллера, настройки всех элементов системы и взаимодействия компонентов между собой.

С появлением HAL можно смело сказать, что STM32 стал лидером в доступности программирования 32битных МК.
Однако использование CMSIS достаточно сильно нагружало систему. Проекты банально много весили. Поэтому чуть позже была выпущена переосмысленная версия библиотеки для низкоуровнего взаимодействия - LL (Low Level).

В своей работе я очень часто использую именно LL поскольку как мне кажется HAL конструкции иногда очень громоздки.
В наших практических работах мы сконцентрируемся на HAL, а LL оставим на факультативное изучение.

#### Практика

- Написание первых программ на STM32.
